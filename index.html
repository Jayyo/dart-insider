<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART Insider Trading Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0a0e14;
            --surface: #0f141b;
            --surface-elevated: #151a22;
            --border: rgba(255, 255, 255, 0.08);
            --text: #e8edf3;
            --text-secondary: #9aa7b8;
            --text-tertiary: #6b7280;
            --accent: #5ec9b5;
            --accent-hover: #4fb19e;
            --accent-subtle: rgba(94, 201, 181, 0.08);
            --success: #5ec9b5;
            --info: #6b9bd1;
            --border-radius: 8px;
            --grid-unit: 8px;
            --font-sans: 'Inter', -apple-system, system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Menlo', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg);
            -webkit-font-smoothing: antialiased;
            font-variant-numeric: tabular-nums;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.008) 0, rgba(255,255,255,0.008) 1px, transparent 1px, transparent 8px);
            pointer-events: none;
            z-index: 0;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; position: relative; z-index: 1; }

        header {
            background: rgba(15, 20, 27, 0.8);
            border-bottom: 1px solid var(--border);
            padding: 14px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon {
            width: 28px; height: 28px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 12px;
            color: #0a0e14;
        }

        .logo-text { font-weight: 600; font-size: 15px; letter-spacing: -0.3px; }
        .logo-text span { color: var(--accent); }

        .status-bar-header { display: flex; align-items: center; gap: 16px; font-size: 12px; color: var(--text-secondary); }
        .status-indicator { display: flex; align-items: center; gap: 6px; }
        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .filter-bar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 18px;
            margin: 20px 0;
        }

        .filter-content { display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-label { font-size: 11px; font-weight: 500; color: var(--text-tertiary); letter-spacing: 0.3px; }

        .date-input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-mono);
            font-size: 12px;
            width: 150px;
            transition: border-color 0.2s ease;
        }

        .date-input:focus { outline: none; border-color: var(--accent); }

        .preset-chips { display: flex; gap: 6px; }
        .chip {
            padding: 7px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chip:hover, .chip.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-subtle);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
        }

        .btn-primary { background: var(--accent); color: #0a0e14; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-ghost:hover { border-color: var(--text-secondary); background: var(--surface-elevated); }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 18px; }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 16px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .stat-card:hover { transform: translateY(-2px); border-color: rgba(94, 201, 181, 0.3); }

        .stat-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .stat-icon {
            width: 28px; height: 28px;
            border-radius: 6px;
            background: var(--accent-subtle);
            border: 1px solid rgba(94, 201, 181, 0.15);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-title { font-size: 11px; font-weight: 500; color: var(--text-tertiary); letter-spacing: 0.3px; }
        .stat-value {
            font-family: var(--font-mono);
            font-size: 28px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }
        .stat-sub { font-size: 12px; color: var(--text-tertiary); }

        .charts-section { display: grid; grid-template-columns: 2fr 1fr; gap: 14px; margin-bottom: 18px; }
        .chart-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .chart-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px;
            color: var(--text);
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .chart-container { position: relative; height: 260px; }

        .table-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 18px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
        }

        .table-title { font-size: 13px; font-weight: 600; color: var(--text); }
        .table-actions { display: flex; gap: 10px; }

        .search-input, .page-size-select {
            padding: 7px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            font-family: var(--font-mono);
        }

        .search-input { width: 220px; }
        .search-input:focus, .page-size-select:focus { outline: none; border-color: var(--accent); }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }

        th:nth-child(1) { width: 50px; }
        th:nth-child(2) { width: 130px; }
        th:nth-child(3) { width: 75px; }
        th:nth-child(4) { width: 65px; }
        th:nth-child(5) { width: 85px; }
        th:nth-child(6) { width: 75px; }
        th:nth-child(7) { width: 100px; }
        th:nth-child(8) { width: 110px; }
        th:nth-child(9) { width: 70px; }
        th:nth-child(10) { width: 180px; max-width: 180px; }
        th:nth-child(11) { width: 85px; }

        th {
            text-align: left;
            padding: 9px 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 0.3px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        th:hover { color: var(--accent); }
        th.text-right, td.text-right { text-align: right; }
        th.text-center, td.text-center { text-align: center; }

        td {
            padding: 9px 10px;
            font-size: 12px;
            font-family: var(--font-mono);
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tbody tr { transition: background 0.15s ease; }
        tbody tr:hover { background: #121a26; }

        .market-badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            border: 1px solid;
        }

        .market-kospi { background: rgba(94, 201, 181, 0.12); color: var(--accent); border-color: rgba(94, 201, 181, 0.25); }
        .market-kosdaq { background: rgba(107, 155, 209, 0.12); color: var(--info); border-color: rgba(107, 155, 209, 0.25); }
        .market-etc { background: rgba(107, 114, 128, 0.12); color: var(--text-tertiary); border-color: rgba(107, 114, 128, 0.25); }

        .number { font-variant-numeric: tabular-nums; }
        .reason-cell { font-size: 11px; max-width: 180px; font-family: var(--font-sans); }
        .reason-content { display: flex; align-items: center; gap: 6px; }
        .reason-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; color: var(--text-secondary); }

        .dart-link-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 3px;
            background: rgba(107, 155, 209, 0.12);
            color: var(--info);
            text-decoration: none;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .dart-link-btn:hover { background: rgba(107, 155, 209, 0.2); }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }

        .pagination-info { font-size: 12px; font-family: var(--font-mono); color: var(--text-secondary); }
        .pagination-buttons { display: flex; gap: 4px; }

        .page-btn {
            width: 30px; height: 30px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .page-btn:hover:not(:disabled), .page-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-subtle);
        }

        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 20, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .loading-spinner {
            width: 40px; height: 40px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { margin-top: 12px; font-size: 12px; color: var(--text-secondary); }

        .progress-bar {
            width: 180px; height: 3px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s ease; }

        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-tertiary); }
        .empty-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }

        footer {
            text-align: center;
            padding: 28px 20px;
            color: var(--text-tertiary);
            font-size: 11px;
            border-top: 1px solid var(--border);
            margin-top: 32px;
        }

        footer a { color: var(--accent); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.12); }

        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-section { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .filter-content { flex-direction: column; }
            .date-input { width: 100%; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading data...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">DI</div>
                    <div class="logo-text">DART <span>Insider</span></div>
                </div>
                <div class="status-bar-header">
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span>Live</span>
                    </div>
                    <span id="lastUpdate">-</span>
                    <span id="dataCount">-</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="filter-bar">
            <div class="filter-content">
                <div class="filter-group">
                    <label class="filter-label">Start Date</label>
                    <input type="date" class="date-input" id="startDate">
                </div>
                <div class="filter-group">
                    <label class="filter-label">End Date</label>
                    <input type="date" class="date-input" id="endDate">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Quick Select</label>
                    <div class="preset-chips">
                        <button class="chip" onclick="setPreset('1w')">1W</button>
                        <button class="chip" onclick="setPreset('1m')">1M</button>
                        <button class="chip" onclick="setPreset('3m')">3M</button>
                    </div>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="fetchBtn" onclick="fetchData()">
                            <span id="fetchBtnText">Load Data</span>
                        </button>
                        <button class="btn btn-ghost" onclick="downloadCSV()" id="csvBtn" disabled>
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        </svg>
                    </div>
                    <span class="stat-title">Companies</span>
                </div>
                <div class="stat-value" id="statCompanies">-</div>
                <div class="stat-sub">Participating firms</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                    </div>
                    <span class="stat-title">Executives</span>
                </div>
                <div class="stat-value" id="statExecutives">-</div>
                <div class="stat-sub">Insider traders</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                            <polyline points="16 7 22 7 22 13"/>
                        </svg>
                    </div>
                    <span class="stat-title">Total Shares</span>
                </div>
                <div class="stat-value" id="statShares">-</div>
                <div class="stat-sub">Purchased volume</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                    </div>
                    <span class="stat-title">Top Buyer</span>
                </div>
                <div class="stat-value" id="statTopCompany" style="font-size: 20px;">-</div>
                <div class="stat-sub" id="statTopCompanySub">-</div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">Top 10 Companies by Volume</div>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Market Distribution</div>
                <div class="chart-container">
                    <canvas id="donutChart"></canvas>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <div class="table-title">Transaction Records</div>
                <div class="table-actions">
                    <select id="pageSizeSelect" class="page-size-select" onchange="changePageSize()">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">All</option>
                    </select>
                    <input type="text" class="search-input" placeholder="Search..." id="searchInput" oninput="filterTable()">
                </div>
            </div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)" class="text-center">#</th>
                            <th onclick="sortTable(1)">Company</th>
                            <th onclick="sortTable(2)" class="text-center">Code</th>
                            <th onclick="sortTable(3)" class="text-center">Market</th>
                            <th onclick="sortTable(4)" class="text-center">Executive</th>
                            <th onclick="sortTable(5)" class="text-center">Position</th>
                            <th onclick="sortTable(6)" class="text-right">Shares</th>
                            <th onclick="sortTable(7)" class="text-right">Total Issued</th>
                            <th onclick="sortTable(8)" class="text-right">Stake %</th>
                            <th onclick="sortTable(9)">Reason</th>
                            <th onclick="sortTable(10)" class="text-center">Date</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="11">
                                <div class="empty-state">
                                    <div class="empty-title">Awaiting Data</div>
                                    <div>Loading transaction records...</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <div class="pagination-info" id="paginationInfo">1-20 / 0</div>
                <div class="pagination-buttons" id="paginationButtons"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Data Source: <a href="https://opendart.fss.or.kr" target="_blank">DART Financial Supervisory Service</a></p>
            <p style="margin-top: 6px;">This service does not provide investment advice.</p>
        </div>
    </footer>

    <script>
        const API_KEY = '9361d74facc8c239f634b08c0f436192de5c14de';
        const BASE_URL = 'https://opendart.fss.or.kr/api';

        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 20;
        let barChart, donutChart;
        let reasonLoadingInProgress = false;

        document.addEventListener('DOMContentLoaded', () => {
            initializeDates();
            initializeCharts();
            fetchData();
        });

        function initializeDates() {
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            document.getElementById('endDate').value = formatDateForInput(today);
            document.getElementById('startDate').value = formatDateForInput(weekAgo);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateForAPI(dateStr) {
            return dateStr.replace(/-/g, '');
        }

        function setPreset(preset) {
            const today = new Date();
            const start = new Date(today);
            switch (preset) {
                case '1w': start.setDate(start.getDate() - 7); break;
                case '1m': start.setMonth(start.getMonth() - 1); break;
                case '3m': start.setMonth(start.getMonth() - 3); break;
            }
            document.getElementById('startDate').value = formatDateForInput(start);
            document.getElementById('endDate').value = formatDateForInput(today);
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
        }

        function initializeCharts() {
            const textColor = '#e8edf3';
            const gridColor = 'rgba(255, 255, 255, 0.05)';

            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: '#5ec9b5', borderRadius: 6, barThickness: 22 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    animation: { duration: 300, easing: 'easeOut' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0f141b',
                            titleColor: textColor,
                            bodyColor: '#9aa7b8',
                            borderColor: 'rgba(255, 255, 255, 0.08)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            titleFont: { family: 'JetBrains Mono', size: 11 },
                            bodyFont: { family: 'JetBrains Mono', size: 11 },
                            callbacks: { label: (c) => c.parsed.x.toLocaleString() + ' shares' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: {
                                color: textColor,
                                font: { family: 'JetBrains Mono', size: 10 },
                                callback: (v) => (v / 1000).toFixed(0) + 'K'
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: textColor, font: { family: 'JetBrains Mono', size: 10 } }
                        }
                    }
                }
            });

            const donutCtx = document.getElementById('donutChart').getContext('2d');
            donutChart = new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['KOSPI', 'KOSDAQ', 'Other'],
                    datasets: [{ data: [0, 0, 0], backgroundColor: ['#5ec9b5', '#6b9bd1', '#6b7280'], borderWidth: 2, borderColor: '#0f141b' }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '68%',
                    animation: { duration: 300, easing: 'easeOut' },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 14, font: { family: 'Inter', size: 11 }, usePointStyle: true, pointStyle: 'circle' }
                        },
                        tooltip: {
                            backgroundColor: '#0f141b',
                            titleColor: textColor,
                            bodyColor: '#9aa7b8',
                            borderColor: 'rgba(255, 255, 255, 0.08)',
                            borderWidth: 1,
                            padding: 10,
                            titleFont: { family: 'JetBrains Mono', size: 11 },
                            bodyFont: { family: 'JetBrains Mono', size: 11 },
                            callbacks: { label: (c) => ' ' + c.label + ': ' + c.parsed }
                        }
                    }
                }
            });
        }

        async function fetchData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) { alert('Please select dates'); return; }

            showLoading();
            updateLoadingText('Fetching data...');
            allData = [];

            try {
                const apiStartDate = formatDateForAPI(startDate);
                const apiEndDate = formatDateForAPI(endDate);
                const response = await fetch('/api/purchases?start_date=' + apiStartDate + '&end_date=' + apiEndDate);
                if (!response.ok) throw new Error('Failed to fetch data');
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Failed to fetch data');
                if (result.data.length === 0) {
                    hideLoading();
                    alert('No data found for this period');
                    return;
                }

                allData = result.data.map(item => ({
                    rcept_no: item.rcept_no,
                    corp_name: item.corp_name,
                    stock_code: item.stock_code,
                    market: item.market,
                    exec_name: item.exec_name,
                    position: item.position,
                    shares: item.shares,
                    total_shares: item.total_shares || 0,
                    rate: item.rate,
                    reason: '',
                    report_date: item.report_date
                }));

                filteredData = [...allData];
                const stats = result.stats;
                const uniqueCompanies = { size: stats.companies };
                const totalShares = stats.total_shares;

                const companyShares = {};
                for (const d of allData) {
                    companyShares[d.corp_name] = (companyShares[d.corp_name] || 0) + d.shares;
                }
                let topCompany = '';
                let topCompanyShares = 0;
                for (const [name, shares] of Object.entries(companyShares)) {
                    if (shares > topCompanyShares) {
                        topCompany = name;
                        topCompanyShares = shares;
                    }
                }

                document.getElementById('statCompanies').textContent = uniqueCompanies.size.toLocaleString();
                document.getElementById('statExecutives').textContent = allData.length.toLocaleString();
                document.getElementById('statShares').textContent = formatNumber(totalShares);

                if (topCompany) {
                    document.getElementById('statTopCompany').textContent = topCompany;
                    document.getElementById('statTopCompanySub').textContent = formatNumber(topCompanyShares) + ' shares';
                }

                updateCharts();
                updateTable();
                hideLoading();

                document.getElementById('csvBtn').disabled = allData.length === 0;
                const updateTime = result.last_updated ? new Date(result.last_updated).toLocaleString('en-US') : new Date().toLocaleString('en-US');
                const sourceLabel = result.source === 'database' ? 'DB' : 'API';
                document.getElementById('lastUpdate').textContent = 'Updated: ' + updateTime + ' (' + sourceLabel + ')';
                document.getElementById('dataCount').textContent = allData.length + ' records';

                loadAllReasonsBackground();

            } catch (error) {
                hideLoading();
                alert('Failed to fetch data: ' + error.message);
                console.error(error);
            }
        }

        function updateCharts() {
            const companyShares = {};
            filteredData.forEach(d => {
                companyShares[d.corp_name] = (companyShares[d.corp_name] || 0) + d.shares;
            });

            const top10 = Object.entries(companyShares).sort((a, b) => b[1] - a[1]).slice(0, 10);
            barChart.data.labels = top10.map(d => d[0]);
            barChart.data.datasets[0].data = top10.map(d => d[1]);
            barChart.update();

            const marketDist = { '코스피': 0, '코스닥': 0, '기타': 0 };
            filteredData.forEach(d => {
                if (marketDist.hasOwnProperty(d.market)) {
                    marketDist[d.market] += d.shares;
                } else {
                    marketDist['기타'] += d.shares;
                }
            });

            donutChart.data.datasets[0].data = [marketDist['코스피'], marketDist['코스닥'], marketDist['기타']];
            donutChart.update();
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredData.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11"><div class="empty-state"><div class="empty-title">No Data</div><div>No transactions found</div></div></td></tr>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            tbody.innerHTML = pageData.map((d, i) => {
                const marketClass = d.market === '코스피' ? 'kospi' : d.market === '코스닥' ? 'kosdaq' : 'etc';
                return '<tr>' +
                    '<td class="number text-center">' + (start + i + 1) + '</td>' +
                    '<td><strong>' + d.corp_name + '</strong></td>' +
                    '<td class="number text-center">' + d.stock_code + '</td>' +
                    '<td class="text-center"><span class="market-badge market-' + marketClass + '">' + d.market + '</span></td>' +
                    '<td class="text-center">' + d.exec_name + '</td>' +
                    '<td class="text-center">' + d.position + '</td>' +
                    '<td class="text-right number"><strong>' + d.shares.toLocaleString() + '</strong></td>' +
                    '<td class="text-right number">' + (d.total_shares ? d.total_shares.toLocaleString() : '-') + '</td>' +
                    '<td class="text-right number">' + d.rate + '%</td>' +
                    '<td class="reason-cell" data-rcept="' + d.rcept_no + '" title="' + (d.reason || '').replace(/"/g, '&quot;') + '">' +
                    '<div class="reason-content">' +
                    '<span class="reason-text">' + (d.reason || '<span class="reason-loading">Loading...</span>') + '</span>' +
                    '<a href="https://dart.fss.or.kr/dsaf001/main.do?rcpNo=' + d.rcept_no + '" target="_blank" class="dart-link-btn" title="View DART">' +
                    '<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">' +
                    '<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>' +
                    '<polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>' +
                    '</div></td>' +
                    '<td class="number text-center">' + (d.report_date || '-') + '</td>' +
                    '</tr>';
            }).join('');

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            document.getElementById('pagination').style.display = 'flex';
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, filteredData.length);
            document.getElementById('paginationInfo').textContent = start + '-' + end + ' / ' + filteredData.length;

            const buttons = document.getElementById('paginationButtons');
            let html = '<button class="page-btn" onclick="goToPage(' + (currentPage - 1) + ')" ' + (currentPage === 1 ? 'disabled' : '') + '>‹</button>';

            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += '<button class="page-btn ' + (i === currentPage ? 'active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</button>';
            }

            html += '<button class="page-btn" onclick="goToPage(' + (currentPage + 1) + ')" ' + (currentPage === totalPages ? 'disabled' : '') + '>›</button>';
            buttons.innerHTML = html;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateTable();
        }

        function filterTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            filteredData = allData.filter(d => d.corp_name.toLowerCase().includes(query) || d.exec_name.toLowerCase().includes(query));
            currentPage = 1;
            updateUI();
        }

        function updateUI() {
            updateStats();
            updateCharts();
            updateTable();
        }

        function updateStats() {
            const companies = new Set(filteredData.map(d => d.corp_name)).size;
            const executives = filteredData.length;
            const totalShares = filteredData.reduce((sum, d) => sum + d.shares, 0);

            document.getElementById('statCompanies').textContent = companies.toLocaleString();
            document.getElementById('statExecutives').textContent = executives.toLocaleString();
            document.getElementById('statShares').textContent = formatNumber(totalShares);

            if (filteredData.length > 0) {
                const companyShares = {};
                filteredData.forEach(d => {
                    companyShares[d.corp_name] = (companyShares[d.corp_name] || 0) + d.shares;
                });
                const topCompany = Object.entries(companyShares).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('statTopCompany').textContent = topCompany[0];
                document.getElementById('statTopCompanySub').textContent = formatNumber(topCompany[1]) + ' shares';
            }
        }

        let sortColumn = -1;
        let sortAsc = true;

        function sortTable(col) {
            if (sortColumn === col) {
                sortAsc = !sortAsc;
            } else {
                sortColumn = col;
                sortAsc = true;
            }

            const keys = ['', 'corp_name', 'stock_code', 'market', 'exec_name', 'position', 'shares', 'total_shares', 'rate', 'reason', 'report_date'];
            const key = keys[col];

            if (key) {
                filteredData.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];
                    if (typeof valA === 'number') {
                        return sortAsc ? valA - valB : valB - valA;
                    }
                    return sortAsc ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
                });
            }

            currentPage = 1;
            updateTable();
        }

        function changePageSize() {
            const select = document.getElementById('pageSizeSelect');
            const value = select.value;
            if (value === 'all') {
                pageSize = filteredData.length || 9999;
            } else {
                pageSize = parseInt(value);
            }
            currentPage = 1;
            updateTable();
        }

        async function loadAllReasonsBackground() {
            if (reasonLoadingInProgress) return;
            reasonLoadingInProgress = true;

            for (const item of allData) {
                if (!item.reason && item.rcept_no) {
                    try {
                        const response = await fetch('/api/report-reason?rcept_no=' + item.rcept_no);
                        const result = await response.json();
                        item.reason = result.reason || '-';

                        const filtered = filteredData.find(d => d.rcept_no === item.rcept_no);
                        if (filtered) filtered.reason = item.reason;

                        const cell = document.querySelector('td[data-rcept="' + item.rcept_no + '"] .reason-text');
                        if (cell && cell.querySelector('.reason-loading')) {
                            cell.innerHTML = item.reason;
                        }
                    } catch (err) {
                        console.error('Failed to load reason:', err);
                    }

                    await new Promise(r => setTimeout(r, 100));
                }
            }

            reasonLoadingInProgress = false;
        }

        function downloadCSV() {
            if (filteredData.length === 0) return;

            const headers = ['No', 'Company', 'Code', 'Market', 'Executive', 'Position', 'Shares', 'Total Issued', 'Stake %', 'Reason', 'Date'];
            const rows = filteredData.map((d, i) => [
                i + 1, d.corp_name, d.stock_code, d.market, d.exec_name, d.position,
                d.shares, d.total_shares || '', d.rate, d.reason || '', d.report_date || ''
            ]);

            const csvContent = [headers, ...rows].map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');

            const link = document.createElement('a');
            link.href = url;
            link.download = 'dart-insider-' + startDate + '-' + endDate + '.csv';
            link.click();

            URL.revokeObjectURL(url);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('fetchBtn').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('fetchBtn').disabled = false;
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function formatNumber(num) {
            if (num >= 100000000) {
                return (num / 100000000).toFixed(1) + 'B';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }
    </script>
</body>
</html>
